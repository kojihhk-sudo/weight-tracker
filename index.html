<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>我的雲端體脂計</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        :root { 
            --p: #4a90e2; --s: #27ae60; --f: #f39c12; --up: #ff5e57; --down: #1dd1a1; 
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --sub: #999; --input: #2d2d2d;
            --bmi-under: #4a90e2; --bmi-normal: #1dd1a1; --bmi-over: #ff5e57;
        }
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* 登入畫面樣式 */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .login-btn { padding: 15px 30px; background: white; color: black; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.9rem; color: var(--sub); }
        .input-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .field { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.75rem; color: var(--sub); }
        input { padding: 12px; border: 1px solid #444; border-radius: 10px; background: var(--input); color: white; width: 100%; box-sizing: border-box; }
        .add-btn { grid-column: span 3; margin-top: 10px; padding: 15px; background: var(--s); color: white; border: none; border-radius: 12px; font-weight: bold; }
        .filter-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #444; background: none; color: var(--sub); }
        .filter-btn.active { background: var(--p); color: white; }
        .chart-container { height: 250px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 12px 5px; text-align: center; border-bottom: 1px solid #333; }
        .hidden { display: none !important; }
        .bmi-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h1 style="color: var(--p)">體重體脂雲端App</h1>
        <p style="color: var(--sub); margin-bottom: 30px;">請登入以同步您的雲端數據</p>
        <button class="login-btn" onclick="login()">
            <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="20"> 使用 Google 帳號登入
        </button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="status-bar">
            <span id="userEmail">--</span>
            <span style="text-decoration: underline; cursor:pointer;" onclick="logout()">登出</span>
        </div>
        
        <div class="status-bar">
            身高: <span id="txtHeight" onclick="toggleHeightEdit(true)" style="color:var(--p); font-weight:bold; cursor:pointer;">--</span> cm
        </div>

        <div id="heightEditArea" class="card hidden">
            <label>設定身高 (cm)</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="number" id="heightInput" placeholder="例如: 175">
                <button onclick="saveHeight()" style="padding:0 20px; background:var(--p); border:none; border-radius:10px; color:white; font-weight:bold;">儲存</button>
            </div>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="field"><label>日期</label><input type="date" id="dateInput"></div>
                <div class="field"><label>體重</label><input type="text" id="weightInput" inputmode="decimal" placeholder="00.0"></div>
                <div class="field"><label>體脂</label><input type="text" id="fatInput" inputmode="decimal" placeholder="00.0"></div>
                <button class="add-btn" onclick="addData()">＋ 儲存紀錄</button>
            </div>
        </div>

        <div class="card">
            <div class="filter-group" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button id="btn7" class="filter-btn" onclick="setSpan(7, this)">1週</button>
                <button id="btn30" class="filter-btn" onclick="setSpan(30, this)">1月</button>
                <button id="btn0" class="filter-btn active" onclick="setSpan(0, this)">全部</button>
            </div>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
        </div>

        <div class="card" style="padding: 10px;">
            <table>
                <thead><tr><th>日期</th><th>體重</th><th>體脂</th><th>BMI</th><th></th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyC3vY9JuePAZ4TWA9TUbRWdhT1_2j9KtQQ",
            authDomain: "my-health-app-e4a35.firebaseapp.com",
            databaseURL: "https://my-health-app-e4a35-default-rtdb.firebaseio.com",
            projectId: "my-health-app-e4a35",
            storageBucket: "my-health-app-e4a35.firebasestorage.app",
            messagingSenderId: "733020341548",
            appId: "1:733020341548:web:0a35fa740573875b55d889"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentUser = null;
        let records = [];
        let userHeight = "";
        let chart = null;
        let currentSpan = 0;

        // 2. 登入/登出 (採用 Popup 彈出方式)
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => {
                alert("登入失敗: " + err.message);
            });
        }

        function logout() {
            if(confirm("確定要登出嗎？")) {
                auth.signOut().then(() => location.reload());
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').innerText = user.email;
                
                // 讀取該用戶專屬路徑
                db.ref('users/' + user.uid).on('value', snapshot => {
                    const data = snapshot.val() || {};
                    records = data.records || [];
                    userHeight = data.height || "";
                    updateDisplay();
                });
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // 3. 資料與 UI 邏輯
        function sync() {
            if (currentUser) {
                db.ref('users/' + currentUser.uid).set({
                    height: userHeight,
                    records: records
                });
            }
        }

        function getBMIInfo(weight) {
            if (!userHeight || !weight) return { val: "--", col: "var(--sub)" };
            const bmi = (weight / ((userHeight/100)**2)).toFixed(1);
            let col = "var(--bmi-normal)";
            if (bmi < 18.5) col = "var(--bmi-under)";
            else if (bmi >= 24) col = "var(--bmi-over)";
            return { val: bmi, col: col };
        }

        function updateDisplay() {
            document.getElementById('txtHeight').innerText = userHeight || "--";
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // 由新到舊排序顯示在表格
            const displayRecords = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            displayRecords.forEach(r => {
                const bmi = getBMIInfo(r.weight);
                tbody.innerHTML += `<tr>
                    <td>${r.date.split('-').slice(1).join('/')}</td>
                    <td>${r.weight.toFixed(1)}</td>
                    <td>${r.fat.toFixed(1)}%</td>
                    <td><span class="bmi-badge" style="color:${bmi.col}">${bmi.val}</span></td>
                    <td><button onclick="deleteRecord('${r.date}')" style="background:none; border:none; color:#555; font-size:1.2rem; cursor:pointer;">✕</button></td>
                </tr>`;
            });

            if(!chart) initChart();
            updateChart();
        }

        function addData() {
            const wInput = document.getElementById('weightInput');
            const fInput = document.getElementById('fatInput');
            const dInput = document.getElementById('dateInput');
            
            if(!wInput.value || !fInput.value) { alert("請輸入數值"); return; }
            
            const newRecord = { 
                date: dInput.value, 
                weight: parseFloat(wInput.value), 
                fat: parseFloat(fInput.value) 
            };
            
            // 如果日期重複則覆蓋
            const idx = records.findIndex(r => r.date === newRecord.date);
            if(idx !== -1) records[idx] = newRecord;
            else records.push(newRecord);
            
            sync();
            wInput.value = ''; fInput.value = '';
        }

        function deleteRecord(date) {
            if(confirm("確定刪除 " + date + " 的紀錄嗎？")) {
                records = records.filter(r => r.date !== date);
                sync();
            }
        }

        function saveHeight() {
            const h = document.getElementById('heightInput').value;
            if(h > 50) {
                userHeight = h;
                sync();
                toggleHeightEdit(false);
            }
        }

        function toggleHeightEdit(show) { document.getElementById('heightEditArea').classList.toggle('hidden', !show); }

        function setSpan(days, btn) {
            currentSpan = days;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [
                    { label: '體重', borderColor: '#4a90e2', data: [], yAxisID: 'yW', tension: 0.1, pointRadius: 3 },
                    { label: '體脂', borderColor: '#f39c12', data: [], yAxisID: 'yF', tension: 0.1, pointRadius: 3 }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } } },
                        yW: { position: 'left', title: { display: true, text: '體重' } },
                        yF: { position: 'right', title: { display: true, text: '體脂' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart() {
            if(!chart) return;
            const sorted = [...records].sort((a,b) => new Date(a.date) - new Date(b.date));
            chart.data.datasets[0].data = sorted.map(r => ({x: new Date(r.date), y: r.weight}));
            chart.data.datasets[1].data = sorted.map(r => ({x: new Date(r.date), y: r.fat}));
            
            if(currentSpan > 0) {
                const max = new Date();
                const min = new Date();
                min.setDate(max.getDate() - currentSpan);
                chart.options.scales.x.min = min;
                chart.options.scales.x.max = max;
            } else {
                chart.options.scales.x.min = null;
                chart.options.scales.x.max = null;
            }
            chart.update();
        }

        // 輸入輔助
        const autoPoint = (e) => {
            let v = e.target.value.replace(/\D/g, '').slice(0,3);
            if(v.length === 3) e.target.value = v.slice(0,2) + "." + v.slice(2);
        };
        document.getElementById('weightInput').oninput = autoPoint;
        document.getElementById('fatInput').oninput = autoPoint;
        document.getElementById('dateInput').valueAsDate = new Date();
    </script>
</body>
</html>
