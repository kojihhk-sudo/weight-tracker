<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>體重體脂雲端App</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        :root { 
            --p: #4a90e2; --s: #27ae60; --f: #f39c12; --up: #ff5e57; --down: #1dd1a1; 
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --sub: #999; --input: #2d2d2d;
            --bmi-under: #4a90e2; --bmi-normal: #1dd1a1; --bmi-over: #ff5e57;
        }
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* 登入畫面樣式 */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .login-btn { padding: 15px 30px; background: white; color: black; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        /* 介面其餘樣式保持 (略...) */
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.9rem; color: var(--sub); }
        .input-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .field { display: flex; flex-direction: column; gap: 4px; }
        input { padding: 12px; border: 1px solid #444; border-radius: 10px; background: var(--input); color: white; width: 100%; box-sizing: border-box; }
        .add-btn { grid-column: span 3; margin-top: 10px; padding: 15px; background: var(--s); color: white; border: none; border-radius: 12px; font-weight: bold; }
        .filter-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #444; background: none; color: var(--sub); }
        .filter-btn.active { background: var(--p); color: white; }
        .chart-container { height: 250px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 12px 5px; text-align: center; border-bottom: 1px solid #333; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h1 style="color: var(--p)">體重體脂記錄App</h1>
        <p style="color: var(--sub); margin-bottom: 30px;">請登入以同步您的雲端數據</p>
        <button class="login-btn" onclick="login()">
            <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="20"> 使用 Google 帳號登入
        </button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="status-bar">
            <span id="userEmail">--</span>
            <span style="text-decoration: underline; cursor:pointer;" onclick="logout()">登出</span>
        </div>
        
        <div class="status-bar">
            身高: <span id="txtHeight" onclick="toggleHeightEdit(true)" style="color:var(--p); font-weight:bold;">--</span> cm
        </div>

        <div id="heightEditArea" class="card hidden">
            <input type="number" id="heightInput" placeholder="設定身高">
            <button onclick="saveHeight()" style="width:100%; margin-top:10px; padding:10px; background:var(--p); border:none; border-radius:10px; color:white;">儲存身高</button>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="field"><label>日期</label><input type="date" id="dateInput"></div>
                <div class="field"><label>體重</label><input type="text" id="weightInput" inputmode="decimal" placeholder="00.0"></div>
                <div class="field"><label>體脂</label><input type="text" id="fatInput" inputmode="decimal" placeholder="00.0"></div>
                <button class="add-btn" onclick="addData()">＋ 儲存紀錄</button>
            </div>
        </div>

        <div class="card">
            <div class="filter-group" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button class="filter-btn" onclick="setSpan(7, this)">1週</button>
                <button class="filter-btn" onclick="setSpan(30, this)">1月</button>
                <button class="filter-btn active" onclick="setSpan(0, this)">全部</button>
            </div>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
        </div>

        <div class="card" style="padding: 10px;">
            <table>
                <thead><tr><th>日期</th><th>體重</th><th>體脂</th><th>BMI</th><th></th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyC3vY9JuePAZ4TWA9TUbRWdhT1_2j9KtQQ",
            authDomain: "my-health-app-e4a35.firebaseapp.com",
            databaseURL: "https://my-health-app-e4a35-default-rtdb.firebaseio.com",
            projectId: "my-health-app-e4a35",
            storageBucket: "my-health-app-e4a35.firebasestorage.app",
            messagingSenderId: "733020341548",
            appId: "1:733020341548:web:0a35fa740573875b55d889"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentUser = null;
        let records = [];
        let userHeight = "";
        let chart = null;

        // 2. 登入/登出邏輯
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider);
        }

        function logout() {
            auth.signOut().then(() => location.reload());
        }

        // 監聽登入狀態
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').innerText = user.email;
                
                // 綁定該使用者的資料路徑
                const userRef = db.ref('users/' + user.uid);
                userRef.on('value', snapshot => {
                    const data = snapshot.val() || {};
                    records = data.records || [];
                    userHeight = data.height || "";
                    updateDisplay();
                });
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // 3. 資料操作 (寫入該用戶專屬路徑)
        function sync() {
            if (!currentUser) return;
            db.ref('users/' + currentUser.uid).set({
                height: userHeight,
                records: records
            });
        }

        // ... 其餘 updateDisplay, addData, initChart 邏輯與之前相同，
        // 僅需確保在修改 records 或 userHeight 後呼叫 sync() 即可 ...
        
        function updateDisplay() {
            // 更新 UI, 重新整理表格與圖表 (同前版本)
            document.getElementById('txtHeight').innerText = userHeight || "--";
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // 排序與顯示邏輯
            records.sort((a,b) => new Date(a.date) - new Date(b.date));
            for(let i=records.length-1; i>=0; i--) {
                const r = records[i];
                const bmi = userHeight ? (r.weight / ((userHeight/100)**2)).toFixed(1) : "--";
                tbody.innerHTML += `<tr>
                    <td>${r.date.split('-').slice(1).join('/')}</td>
                    <td>${r.weight}</td>
                    <td>${r.fat}%</td>
                    <td>${bmi}</td>
                    <td><button onclick="deleteRecord('${r.date}')" style="background:none; border:none; color:#555;">✕</button></td>
                </tr>`;
            }
            if(!chart) initChart();
            updateChart();
        }

        function addData() {
            const w = document.getElementById('weightInput').value;
            const f = document.getElementById('fatInput').value;
            const d = document.getElementById('dateInput').value;
            if(!w || !f) return;
            records.push({ date: d, weight: parseFloat(w), fat: parseFloat(f) });
            sync(); // 同步回雲端
        }

        function deleteRecord(date) {
            records = records.filter(r => r.date !== date);
            sync();
        }

        function saveHeight() {
            userHeight = document.getElementById('heightInput').value;
            sync();
            toggleHeightEdit(false);
        }

        function toggleHeightEdit(show) { document.getElementById('heightEditArea').classList.toggle('hidden', !show); }
        function setSpan(days, btn) { /* 同前邏輯... */ }
        function initChart() { /* 同前版本，使用 Chart.js ... */ }
        function updateChart() { /* 同前版本 ... */ }
        
        // 自動補點點邏輯
        document.getElementById('weightInput').oninput = function() {
            if(this.value.length === 3 && !this.value.includes('.')) this.value = this.value.slice(0,2) + '.' + this.value.slice(2);
        };
        document.getElementById('fatInput').oninput = document.getElementById('weightInput').oninput;
        document.getElementById('dateInput').valueAsDate = new Date();
    </script>
</body>
</html>