<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>我的體重體脂記錄</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        :root { 
            --p: #4a90e2; --s: #27ae60; --f: #f39c12; --bg: #121212; --card: #1e1e1e; 
            --text: #e0e0e0; --sub: #999; --input: #2d2d2d; --grid: #333;
            --bmi-normal: #1dd1a1; --bmi-under: #4a90e2; --bmi-over: #ff5e57;
        }
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; background: var(--bg); color: var(--text); }
        .card { background: var(--card); padding: 15px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .login-btn { padding: 15px 30px; background: white; color: black; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.85rem; color: var(--sub); }
        
        .height-row { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 0.9rem; }
        #heightEditArea { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 15px; }
        #heightInput { width: 70px; padding: 6px; text-align: center; border-radius: 8px; border: 1px solid #444; background: var(--input); color: white; }

        .input-group { 
            display: grid; 
            grid-template-columns: 1.2fr 0.9fr 0.9fr; 
            gap: 5px; 
        }
        .field { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        label { font-size: 0.65rem; color: var(--sub); padding-left: 1px; white-space: nowrap; }
        
        input { 
            height: 44px; 
            padding: 0 2px; 
            border: 1px solid #444; 
            border-radius: 10px; 
            background: var(--input); 
            color: white; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 0.85rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
        }

        #dateInput::-webkit-date-and-time-value {
            text-align: center;
            margin: 0;
            line-height: 44px;
            height: 44px;
        }
        
        #dateInput { font-size: 0.75rem; }

        .add-btn { grid-column: span 3; margin-top: 10px; padding: 14px; background: var(--s); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        
        .filter-group { display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; }
        .filter-btn { padding: 8px 5px; border-radius: 20px; border: 1px solid #444; background: none; color: var(--sub); cursor: pointer; font-size: 0.7rem; flex: 1; max-width: 85px; text-align: center; }
        .filter-btn.active { background: var(--p); color: white; border-color: var(--p); }
        
        .chart-container { height: 250px; position: relative; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85rem; table-layout: fixed; }
        th { color: var(--sub); font-weight: normal; font-size: 0.75rem; }
        td, th { padding: 12px 2px; text-align: center; border-bottom: 1px solid #333; overflow: hidden; text-overflow: ellipsis; }
        .bmi-badge { padding: 2px 4px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h1 style="color: var(--p)">我的體重體脂記錄</h1>
        <button class="login-btn" onclick="login()">使用 Google 帳號登入</button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="status-bar">
            <span id="userEmail">--</span>
            <span style="text-decoration: underline; cursor:pointer;" onclick="logout()">登出</span>
        </div>
        
        <div class="height-row" id="heightShowArea">
            <span>身高: <strong id="txtHeight" style="color:var(--p); cursor:pointer;" onclick="toggleHeightEdit(true)">--</strong> cm</span>
        </div>

        <div id="heightEditArea" class="hidden">
            <input type="number" id="heightInput" placeholder="cm">
            <button onclick="saveHeight()" style="padding:6px 12px; background:var(--p); border:none; border-radius:8px; color:white;">儲存</button>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="field"><label>日期</label><input type="date" id="dateInput"></div>
                <div class="field"><label>體重</label><input type="text" id="weightInput" inputmode="decimal" placeholder="00.0"></div>
                <div class="field"><label>體脂</label><input type="text" id="fatInput" inputmode="decimal" placeholder="00.0"></div>
                <button class="add-btn" onclick="addData()">＋ 儲存紀錄</button>
            </div>
        </div>

        <div class="card">
            <div class="filter-group">
                <button id="btn30" class="filter-btn" onclick="setSpan(30, this)">1個月</button>
                <button id="btn90" class="filter-btn" onclick="setSpan(90, this)">3個月</button>
                <button id="btn365" class="filter-btn" onclick="setSpan(365, this)">1年</button>
                <button id="btn0" class="filter-btn active" onclick="setSpan(0, this)">全部</button>
            </div>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
        </div>

        <div class="card" style="padding: 10px;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 28%;">日期</th>
                        <th style="width: 22%;">體重</th>
                        <th style="width: 22%;">體脂</th>
                        <th style="width: 18%;">BMI</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC3vY9JuePAZ4TWA9TUbRWdhT1_2j9KtQQ",
            authDomain: "my-health-app-e4a35.firebaseapp.com",
            databaseURL: "https://my-health-app-e4a35-default-rtdb.firebaseio.com",
            projectId: "my-health-app-e4a35",
            storageBucket: "my-health-app-e4a35.firebasestorage.app",
            messagingSenderId: "733020341548",
            appId: "1:733020341548:web:0a35fa740573875b55d889"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        let currentUser = null;
        let records = [];
        let userHeight = "";
        let chart = null;
        let currentSpan = 0;

        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => {
                if (err.code === 'auth/popup-blocked') auth.signInWithRedirect(provider);
                else alert("登入失敗: " + err.message);
            });
        }

        function logout() { if(confirm("確定登出？")) auth.signOut().then(() => location.reload()); }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').innerText = user.email;
                db.ref('users/' + user.uid).on('value', snapshot => {
                    const data = snapshot.val() || {};
                    records = data.records || [];
                    userHeight = data.height || "";
                    updateDisplay();
                });
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function sync() {
            if (currentUser) db.ref('users/' + currentUser.uid).set({ height: userHeight, records: records });
        }

        function updateDisplay() {
            document.getElementById('txtHeight').innerText = userHeight || "--";
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const displayRecords = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            displayRecords.forEach(r => {
                const bmiVal = userHeight ? (r.weight / ((userHeight/100)**2)).toFixed(1) : "--";
                let bmiCol = "var(--bmi-normal)";
                if (bmiVal < 18.5) bmiCol = "var(--bmi-under)";
                else if (bmiVal >= 24) bmiCol = "var(--bmi-over)";

                const d = new Date(r.date.replace(/-/g, "/"));
                const yy = String(d.getFullYear()).slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const formattedDate = `'${yy}/${mm}/${dd}`;

                tbody.innerHTML += `<tr>
                    <td>${formattedDate}</td>
                    <td>${Number(r.weight).toFixed(1)}</td>
                    <td>${Number(r.fat).toFixed(1)}%</td>
                    <td><span class="bmi-badge" style="color:${bmiCol}">${bmiVal}</span></td>
                    <td><button onclick="deleteRecord('${r.date}')" style="background:none; border:none; color:#555; cursor:pointer;">✕</button></td>
                </tr>`;
            });
            if(!chart) initChart();
            updateChart();
        }

        function addData() {
            const w = document.getElementById('weightInput');
            const f = document.getElementById('fatInput');
            const d = document.getElementById('dateInput');
            if(!w.value || !f.value) return;
            const newR = { date: d.value, weight: parseFloat(w.value), fat: parseFloat(f.value) };
            const idx = records.findIndex(r => r.date === newR.date);
            if(idx !== -1) records[idx] = newR;
            else records.push(newR);
            sync();
            w.value = ''; f.value = '';
        }

        function deleteRecord(date) {
            if(confirm("刪除紀錄？")) { records = records.filter(r => r.date !== date); sync(); }
        }

        function saveHeight() {
            const h = document.getElementById('heightInput').value;
            if(h > 50) { userHeight = h; sync(); toggleHeightEdit(false); }
        }

        function toggleHeightEdit(show) { 
            document.getElementById('heightEditArea').classList.toggle('hidden', !show); 
            document.getElementById('heightShowArea').classList.toggle('hidden', show); 
        }
        
        function setSpan(days, btn) {
            currentSpan = days;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [
                    { label: '體重', borderColor: '#4a90e2', backgroundColor: '#4a90e2', data: [], yAxisID: 'yW', tension: 0, pointRadius: 4 },
                    { label: '體脂', borderColor: '#f39c12', backgroundColor: '#f39c12', data: [], yAxisID: 'yF', tension: 0, pointRadius: 4 }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } }, grid: { color: '#333' } },
                        yW: { position: 'left', grid: { color: '#333' }, ticks: { color: '#4a90e2' } },
                        yF: { position: 'right', grid: { display: false }, ticks: { color: '#f39c12' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart() {
            if(!chart || records.length === 0) return;
            const sorted = [...records].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            // 提取數據以計算軸範圍
            const weights = sorted.map(r => r.weight);
            const fats = sorted.map(r => r.fat);
            
            // 體重轴 (yW) - 保持在畫面上半部
            const minW = Math.min(...weights);
            const maxW = Math.max(...weights);
            chart.options.scales.yW.min = minW - (maxW - minW) * 0.1 - 2; // 下留空間
            chart.options.scales.yW.max = maxW + (maxW - minW) * 0.8 + 5; // 上留大量空間
            
            // 體脂轴 (yF) - 保持在畫面下半部
            const minF = Math.min(...fats);
            const maxF = Math.max(...fats);
            chart.options.scales.yF.min = minF - (maxF - minF) * 0.8 - 5; // 下留大量空間
            chart.options.scales.yF.max = maxF + (maxF - minF) * 0.1 + 2; // 上留空間

            chart.data.datasets[0].data = sorted.map(r => ({x: new Date(r.date), y: r.weight}));
            chart.data.datasets[1].data = sorted.map(r => ({x: new Date(r.date), y: r.fat}));
            
            if(currentSpan > 0) {
                const max = new Date(); const min = new Date();
                min.setDate(max.getDate() - currentSpan);
                chart.options.scales.x.min = min; chart.options.scales.x.max = max;
            } else { chart.options.scales.x.min = null; chart.options.scales.x.max = null; }
            
            chart.update();
        }

        const autoPoint = (e) => {
            let v = e.target.value.replace(/\D/g, '').slice(0,3);
            if(v.length === 3) e.target.value = v.slice(0,2) + "." + v.slice(2);
        };
        document.getElementById('weightInput').oninput = autoPoint;
        document.getElementById('fatInput').oninput = autoPoint;
        document.getElementById('dateInput').valueAsDate = new Date();
    </script>
</body>
</html>
